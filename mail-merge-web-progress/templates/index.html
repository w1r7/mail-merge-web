<!DOCTYPE html>
<label class="block font-medium">Row start (â‰¥ 4)</label>
<input type="number" name="row_start" min="4" required class="mt-2 w-full border rounded-lg p-2" />
</div>
<div>
<label class="block font-medium">Row end (â‰¥ 4)</label>
<input type="number" name="row_end" min="4" required class="mt-2 w-full border rounded-lg p-2" />
</div>
</div>
<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700">ğŸš€ Run Mail Merge</button>
</form>


<div id="progressWrap" class="mt-6 hidden">
<div class="flex items-center justify-between mb-2">
<span id="progressLabel" class="text-sm font-medium text-gray-700">Startingâ€¦</span>
<span id="etaLabel" class="text-sm text-gray-500">ETA: â€”</span>
</div>
<div class="w-full bg-gray-200 rounded-full h-3">
<div id="progressBar" class="bg-blue-600 h-3 rounded-full" style="width:0%"></div>
</div>
<div id="resultLink" class="mt-3 text-center"></div>
</div>
</div>


<script>
const form = document.getElementById('mergeForm');
const progressWrap = document.getElementById('progressWrap');
const progressBar = document.getElementById('progressBar');
const progressLabel = document.getElementById('progressLabel');
const etaLabel = document.getElementById('etaLabel');
const resultLink = document.getElementById('resultLink');


const fmtETA = (s) => {
if (s == null) return 'â€”';
s = Math.max(0, Number(s) || 0);
const m = Math.floor(s / 60);
const r = s % 60;
return `${m}:${r.toString().padStart(2, '0')}`;
};


form.addEventListener('submit', async (e) => {
e.preventDefault();
const fd = new FormData(form);
const rs = Number(fd.get('row_start'));
const re = Number(fd.get('row_end'));
if (rs < 4 || re < 4) { alert('âŒ Rows must be â‰¥ 4'); return; }
if (rs > re) { alert('Row start cannot be greater than row end.'); return; }


progressWrap.classList.remove('hidden');
progressBar.style.width = '0%';
progressLabel.textContent = 'Uploadingâ€¦';
etaLabel.textContent = 'ETA: â€”';
resultLink.innerHTML = '';


const res = await fetch('/start', { method: 'POST', body: fd });
const data = await res.json();
if (!res.ok) { alert('âŒ ' + (data.error || 'Failed to start')); return; }


const jobId = data.job_id;
const timer = setInterval(async () => {
const pr = await fetch(`/progress/${jobId}`);
const pj = await pr.json();
if (pj.error) { clearInterval(timer); alert('âŒ ' + pj.error); return; }


progressBar.style.width = `${pj.progress || 0}%`;
progressLabel.textContent = pj.message || '';
etaLabel.textContent = 'ETA: ' + fmtETA(pj.eta_seconds);


if (pj.status === 'done') {
clearInterval(timer);
resultLink.innerHTML = `<a href="/download/${jobId}" class="inline-block mt-2 text-blue-700 underline">â¬‡ï¸ Download ${pj.result_name || 'result'}</a>`;
} else if (pj.status === 'error') {
clearInterval(timer);
alert('âŒ ' + (pj.message || 'Error'));
}
}, 1000);
});
</script>
</body>
</html>
